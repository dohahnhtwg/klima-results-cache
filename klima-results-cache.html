<link rel="import" href="/bower_components/polymer/polymer.html"></script>
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html"></script>

<!--
`klima-results-cache`
Fetches result from Klima server and prepares data for views

@demo demo/index.html
-->

<script>
var KlimaResultsBehavior = (function () {
  var results;

  var klimaResults = {
    properties: {
      results: {
        type: Object,
        value: function() {
          return getResults();
        }
      },
      ajax: {
        type: Object,
        value: function() {
          var ajaxEle = document.getElementById("resultsAjax");
          if(ajaxEle == null) {
            ajaxEle = document.createElement('iron-ajax');
            ajaxEle.setAttribute("id", "resultsAjax");
            ajaxEle.setAttribute("auto", "true");
            ajaxEle.setAttribute("handle-as", "json");
            document.body.appendChild(ajaxEle);
          }
          return ajaxEle;
        }
      }
    },

    ready: function() {

    },

    getChartData: function(domainName, departmentName, valueOfInterest, callback) {
      var department = this[domainName][departmentName];
      if(!department) {
        this.$.ajax.url = "allocationData";
        this.$.ajax.response = function(e) {
          allocationData[department] = e.detail.response;
          var chartData = this._buildChartData(department, valueOfInterest);
          callback(chartData);
        }
        this.$.ajax.generateRequest();
      } else {
        var chartData = this._buildChartData(department, valueOfInterest);
        callback(chartData);
      }
    },

    _buildChartData: function(department, valueOfInterest, columns) {
      var rows = new Array();
      department.foreach(function(periodResults) {
        var valueOfInterestResult = periodResults.foreach(function(value) {
            return value.id == valueOfInterest;
        });
        var row = new Array();
        columns.foreach(function(column) {
          row.push(valueOfInterestResult[column]);
        });
        rows.push(row);
      });
      return rows;
    },

    getTableData: function(period, domainKey, departmentKey, callback) {
      var domain = this.results[domainKey];
      if(!domain) {
        this.ajax.setAttribute("url", "/" + domainKey + ".json");
        this.ajax.addEventListener("response", function(e) {
          this.results[domainKey] = e.detail.response;
          var tableData = this._buildTableData(period, e.detail.response, departmentKey);
          callback(tableData);
        }.bind(this));
      } else {

      }
    },

    _buildTableData: function(period, domain, departmentKey) {
      var department = this._getDepartment(domain, departmentKey);
      var periodResults = department.periodResults[period];
      var tableData = {};
      tableData.items = this._buildTableItems(periodResults);
      tableData.columns = this._buildTableColumns(periodResults);
      tableData.header = this._buildHeader(periodResults);
      return tableData
    },

    _getDepartment: function(domain, departmentKey) {
      return domain.departmentResults.find(function(department) {
        return department.key ===  departmentKey;
      });
    },

    _buildTableItems: function(periodResults) {
      var items = [];
      periodResults.rows.forEach(function(entry) {
        var preparedEntry = {description: entry.caption};
          for(var i=0;i<entry.values.length;i++) {
            preparedEntry[periodResults.columns[i].key] = entry.values[i]
          }
          items.push(preparedEntry);
      });
      return items;
    },

    _buildTableColumns: function(periodResults) {
      var columns = [];
      periodResults.columns.forEach(function(entry) {
        var preparedEntry = {name: entry.key};
        columns.push(preparedEntry);
      });
      return columns;
    },

    _buildHeader: function(periodResults) {
      var header = [];
      periodResults.columns.forEach(function(entry) {
        header.push(entry.caption);
      });
      return header;
    }
  };

  getResults = function() {
    if(results == null) {
      results = {
        allocationData: null,
        contributionMargin: null,
        fullCosts: null,
        periodResults: null,
        personal: null,
        arrivalRates: null,
        qualities: null
      };
      return results;
    }
    return results;
  }

  return klimaResults;
})();
</script>
