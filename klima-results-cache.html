<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">

<!--
`klima-results-cache`
Fetches result from Klima server and prepares data for views

@demo demo/index.html
-->

<script>
var KlimaResultsBehavior = (function () {
  var results;

  var klimaResults = {
    properties: {
      results: {
        type: Object,
        value: function() {
          return getResults();
        }
      },
      ajax: {
        type: Object,
        value: function() {
          var ajaxEle = document.getElementById("resultsAjax");
          if(ajaxEle == null) {
            ajaxEle = document.createElement('iron-ajax');
            ajaxEle.setAttribute("id", "resultsAjax");
            ajaxEle.setAttribute("handle-as", "json");
            document.body.appendChild(ajaxEle);
          }
          return ajaxEle;
        }		        
	  },
      colors: {
        type: Array,
        value: ['#f44336','#2196f3', '#4caf50', '#fdd835', '#ff9800', '#00bcd4', '#9c27b0', '#cddc39', '#e91e63', '#009688']
      }
    },

    ready: function() {

    },

    getChartData: function(valueOfInterest, domainKey, departmentKey, callback) {
      var domain = this.results[domainKey];
      if(!domain) {
        var responseMethod = function(e) {
          this.ajax.removeEventListener("response", responseMethod);
          this.results[domainKey] = e.detail.response;
          var chartData = this._buildChartData(valueOfInterest,
            e.detail.response, departmentKey);
          callback(chartData);
        }.bind(this);
        this.ajax.addEventListener("response", responseMethod);
        this.ajax.setAttribute("url", "/json/" + domainKey + ".json");
        this.ajax.generateRequest()
      } else {
        var chartData = this._buildChartData(valueOfInterest,
          this.results[domainKey], departmentKey);
        callback(chartData);
      }
    },

    _buildChartData: function(valueOfInterest, domain, departmentKey) {
      var department = this._getDepartment(domain, departmentKey);
      var cols = this._buildChartCols(department, valueOfInterest);
      var rows = this._buildChartRows(department, valueOfInterest);
      var chartData = {cols: cols, rows: rows};
      return chartData;
    },

    _buildChartCols: function(department, valueOfInterest) {
      var cols = [];
      cols.push({label: "period", type: "string", id: "period"})
      department.periodResults[0].columns.forEach(function(entry) {
        cols.push({label: entry.caption, type: "number", id: entry.key})
      })
      return cols;
    },

    _buildChartRows: function(department, valueOfInterest) {
      var rows = [];
      var i = 0;
      department.periodResults.forEach(function(periodResult) {
        var values = periodResult.rows.find(function(row) {
          return row.key === valueOfInterest;
        }).values;
        var rowOfInterest = [i.toString()];
        values.forEach(function(value) {
          rowOfInterest.push(parseFloat(value));
        });
        rows.push(rowOfInterest);
        i++;
      })
      return rows;
    },

    getTableData: function(period, domainKey, departmentKey, callback) {
      var domain = this.results[domainKey];
      if(!domain) {
        this.ajax.setAttribute("url", "/json/" + domainKey + ".json");
        this.ajax.generateRequest();
        this.ajax.addEventListener("response", function(e) {
          this.results[domainKey] = e.detail.response;
          var tableData = this._buildTableData(period,
            e.detail.response, departmentKey);
          callback(tableData);
        }.bind(this));
      } else {
        var tableData = this._buildTableData(period,
          this.results[domainKey], departmentKey);
        callback(tableData);
      }
    },

    _buildTableData: function(period, domain, departmentKey) {
      var department = this._getDepartment(domain, departmentKey);
      var periodResult = department.periodResults[period];
      var tableData = {};
      tableData.items = this._buildTableItems(periodResult);
      tableData.columns = this._buildTableColumns(periodResult);
      tableData.header = this._buildHeader(periodResult);
      return tableData
    },

    _getDepartment: function(domain, departmentKey) {
      return domain.departmentResults.find(function(department) {
        return department.key ===  departmentKey;
      });
    },

    _buildTableItems: function(periodResult) {
      var items = [];
      periodResult.rows.forEach(function(entry) {
        var preparedEntry = {description: entry.caption};
        for(var i=0;i<entry.values.length;i++) {
          preparedEntry[periodResult.columns[i].key] = entry.values[i]
        }
        items.push(preparedEntry);
      });
      return items;
    },

    _buildTableColumns: function(periodResult) {
      var columns = [];
      columns.push({name: "description"});
      periodResult.columns.forEach(function(entry) {
        var preparedEntry = {name: entry.key};
        columns.push(preparedEntry);
      });
      return columns;
    },

    _buildHeader: function(periodResult) {
      var header = [];
      header.push("");
      periodResult.columns.forEach(function(entry) {
        header.push(entry.caption);
      });
      return header;
    }
  };

  getResults = function() {
    if(results == null) {
      results = {
        allocationData: null,
        contributionMargin: null,
        fullCosts: null,
        periodResults: null,
        personal: null,
        arrivalRates: null,
        qualities: null
      };
      return results;
    }
    return results;
  }

  return klimaResults;
})();
</script>
