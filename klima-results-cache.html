<link rel="import" href="/bower_components/polymer/polymer.html"></script>
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html"></script>

<!--
`klima-results-cache`
Fetches result from Klima server and prepares data for views

@demo demo/index.html
-->

<script>
var KlimaResultsBehavior = (function () {
  var results;

  var klimaResults = {
    properties: {
      results: {
        type: Object,
        value: function() {
          return getResults();
        }
      },
      ajax: {
        type: Object,
        value: function() {
          var ajaxEle = document.getElementById("resultsAjax");
          if(ajaxEle == null) {
            ajaxEle = document.createElement('iron-ajax');
            ajaxEle.setAttribute("id", "resultsAjax");
            ajaxEle.setAttribute("auto", "true");
            ajaxEle.setAttribute("handle-as", "json");
            ajaxEle.setAttribute("url", "/test.json");
            document.body.appendChild(ajaxEle);
          }
          return ajaxEle;
        }
      }
    },

    ready: function() {

    },

    getChartData: function(domainName, departmentName, valueOfInterest, callback) {
      var department = this[domainName][departmentName];
      if(!department) {
        this.$.ajax.url = "something";
        this.$.ajax.response = function(e) {
          allocationData[department] = e.result.data;
          var chartData = this._buildChartData(department, valueOfInterest);
          callback(chartData);
        }
        this.$.ajax.generateRequest();
      } else {
        var chartData = this._buildChartData(department, valueOfInterest);
        callback(chartData);
      }
    },

    _buildChartData: function(department, valueOfInterest, columns) {
      var rows = new Array();
      department.foreach(function(periodResults) {
        var valueOfInterestResult = periodResults.foreach(function(value) {
            return value.id == valueOfInterest;
        });
        var row = new Array();
        columns.foreach(function(column) {
          row.push(valueOfInterestResult[column]);
        });
        rows.push(row);
      });
      return rows;
    },

    getTableData: function(period, domainKey, departmentKey, callback) {
      var domain = this.results[domainKey];
      if(!domain) {
        this.ajax.setAttribute("url", "/" + domainKey + ".json");
        this.ajax.addEventListener("response", function(e) {
          this.results[domainKey] = e.detail.response;
          var tableData = this._buildTableData(period, departmentKey, e.detail.response);
          callback(tableData);
        });
      } else {

      }
    },

    _buildTableData: function(period, departmentKey, domain) {
      console.log("moment");
      return domain.departmentResults.find(function(department) {
        console.log(department);
        return department.key ===  departmentKey;
      });
    }
  };

  getResults = function() {
    if(results == null) {
      results = {
        allocationData: {},
        contributionMargin: {},
        fullCosts: {},
        periodResults: {},
        personal: {},
        arrivalRates: {},
        qualities: {}
      };
      return results;
    }
    return results;
  }

  return klimaResults;
})();
</script>
